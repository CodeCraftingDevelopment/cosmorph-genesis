name: Move issue to In Progress

on:
  push:
    branches:
      - '**'

jobs:
  move_issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Move issues via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Récupère tous les refs #ID
          ISSUES=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=%B | grep -oE 'refs #[0-9]+' | tr -d 'refs #' | tr '\n' ' ')

          # ID du projet v2
          PROJECT_ID="PVT_kwHODXeC6c4BAqMI"
          STATUS_FIELD_ID="PVTSSF_lAHODXeC6c4BAqMIzgzZahU"
          OPTION_ID="47fc9ee4"

          for ISSUE_ID in $ISSUES; do
            echo "Moving issue $ISSUE_ID to In Progress"

            # Récupérer l'ID de l'item dans le projet v2
            ITEM_ID=$(curl -s -H "Authorization: bearer $GITHUB_TOKEN" \
              -X POST -d "{\"query\":\"query { repository(owner: \\\"${GITHUB_REPOSITORY_OWNER}\\\", name: \\\"${GITHUB_REPOSITORY_NAME}\\\") { issue(number: $ISSUE_ID) { id } } }\"}" \
              https://api.github.com/graphql | jq -r '.data.repository.issue.id')

            # Mettre à jour le champ Status pour déplacer l'item en In Progress
            curl -s -H "Authorization: bearer $GITHUB_TOKEN" -X POST \
              -d "{\"query\":\"mutation { updateProjectV2ItemFieldValue(input: { projectId: \\\"$PROJECT_ID\\\", itemId: \\\"$ITEM_ID\\\", fieldId: \\\"$STATUS_FIELD_ID\\\", value: { singleSelectOptionId: \\\"$OPTION_ID\\\" } }) { projectV2Item { id } } }\"}" \
              https://api.github.com/graphql
          done
