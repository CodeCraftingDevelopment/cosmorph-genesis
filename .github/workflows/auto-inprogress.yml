name: Move issue to In Progress

on:
  push:
    branches:
      - '**'

jobs:
  move_issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Move issues via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_ID: "PVT_kwHODXeC6c4BAqMI"
          STATUS_FIELD_ID: "PVTSSF_lAHODXeC6c4BAqMIzgzZahU"
          OPTION_ID: "47fc9ee4"
        run: |
          # RÃ©cupÃ¨re les messages des commits entre before..sha (ou dernier commit si before invalide)
          COMMITS=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=%B 2>/dev/null || git log -1 --pretty=%B)

          # Extrait tous les "refs #ID"
          ISSUES=$(echo "$COMMITS" | grep -oE 'refs #[0-9]+' | tr -d 'refs #' | tr '\n' ' ')

          echo "Issues dÃ©tectÃ©es: $ISSUES"

          for ISSUE_ID in $ISSUES; do
            echo "ðŸ” Processing issue #$ISSUE_ID"

            # RÃ©cupÃ©rer l'ID de l'item dans le projet v2 liÃ© Ã  cette issue
            ITEM_ID=$(curl -s -H "Authorization: bearer $GITHUB_TOKEN" \
              -X POST -d "{\"query\":\"query { repository(owner: \\\"${GITHUB_REPOSITORY_OWNER}\\\", name: \\\"${GITHUB_REPOSITORY_NAME}\\\") { issue(number: $ISSUE_ID) { projectItems(first: 10) { nodes { id project { id } } } } } }\"}" \
              https://api.github.com/graphql | jq -r --arg PROJECT_ID "$PROJECT_ID" '.data.repository.issue.projectItems.nodes[] | select(.project.id == $PROJECT_ID) | .id')

            if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" == "null" ]; then
              echo "âš ï¸ Aucun projet liÃ© trouvÃ© pour lâ€™issue #$ISSUE_ID â†’ ignorÃ©."
              continue
            fi

            echo "âœ… Found project item: $ITEM_ID â†’ Moving to In Progress"

            # Mettre Ã  jour le champ Status -> In Progress
            curl -s -H "Authorization: bearer $GITHUB_TOKEN" -X POST \
              -d "{\"query\":\"mutation { updateProjectV2ItemFieldValue(input: { projectId: \\\"$PROJECT_ID\\\", itemId: \\\"$ITEM_ID\\\", fieldId: \\\"$STATUS_FIELD_ID\\\", value: { singleSelectOptionId: \\\"$OPTION_ID\\\" } }) { projectV2Item { id } } }\"}" \
              https://api.github.com/graphql
          done
